'use strict';

const request = require('request');
const Promise = require('bluebird');


const parseJSON = require('./parseJSON');
const ERRORS = require('./errors');

const BASE_API_URL = 'http://www.cleverbot.com/getreply?key={apikey}&input={input}';

function export_function(settings) {

  return function query(input, cs) {
      return new Promise(function(resolve, reject) {
        var CS_STRING = '&cs={cs}';

        let requestURL =
          BASE_API_URL
          .replace('{apikey}', settings.key)
          .replace('{input}', input);

        if (cs != '')
          requestURL +=
            CS_STRING
            .replace('{cs}', cs);
        requestURL = encodeURI(requestURL).replace(/%5B/g, '[').replace(/%5D/g, ']');
        request(requestURL,
          function (err, httpResponse, body) {
            if (err)
              return reject(err);

            let status = httpResponse.statusCode;
            if (status == 200)
              return resolve(parseJSON(body));
            reject(ERRORS[status.toString()] || ERRORS.DEFAULT);

          });
      });
    };
}

module.exports = export_function;
